import os
import pandas as pd
import numpy as np
from sqlalchemy import create_engine, text
 
# Set Kaggle API credentials (make sure kaggle.json is in ~/.kaggle or set env vars)
# os.environ['KAGGLE_USERNAME'] = 'your_username'
# os.environ['KAGGLE_KEY'] = 'your_key'
 
# Download the dataset using Kaggle API
os.system('kaggle datasets download -d gauravpathak1789/yellow-tripdata-2020-01 --unzip -p ./data')
 
# Find the CSV file (adjust filename if needed)
csv_path = './data/yellow_tripdata_2020-01.csv'
 
# Load data
df = pd.read_csv(csv_path)
 
print(f"Total rows fetched: {len(df)}")
 
# Example transformation: drop duplicates by 'VendorID'
df = df.drop_duplicates(subset="VendorID")
 
# Example transformation: add log of trip_distance
df["trip_distance_log"] = df["trip_distance"].apply(lambda x: np.log(x) if x > 0 else None)
 
# Example normalization
if "total_amount" in df.columns:
    df["total_amount_normalized"] = (df["total_amount"] - df["total_amount"].mean()) / df["total_amount"].std()
 
print("Transformations applied")
print(df.head(5))
 
# Save DataFrame to MySQL
mssql_engine = "mysql+mysqlconnector://root:cfg%401234@localhost/cryptodb"
df.to_sql("yellow_tripdata", mssql_engine, if_exists="replace", index=False)
print("Data inserted into MySQL")
 
# Query row count from MySQL
with create_engine(mssql_engine).connect() as conn:
    result = conn.execute(text("SELECT COUNT(*) FROM yellow_tripdata"))
    print("MySQL row count:", result.scalar())
 
 
